<!DOCTYPE html="html">
<html style="height: 100%">

<head>
  <meta charset="utf-8">
  <title>视频爬取AV</title>
  <link rel="icon" href="logo.jpg" type="image/x-icon">
  <link rel="stylesheet" href="layui/css/layui.css">

  <style>
    :root {
      --themeColor: #8FB3FF;
      --subColor: #000
    }

    body {
      width: 100vw;
      height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      place-content: center;
      background: #000;
      color: #fff;
      backdrop-filter: blur(5px);
      background-size: 100% !important;
      font-size: 16px;
    }

    form {
      color: #000;
      width: 450px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      padding: 40px;
      border: 2px solid #000;
      background-color: #fff;
      position: relative;
      padding-bottom: 80px;
    }

    label {
      text-align: left;
      font-size: 20px;
      display: flex;
      flex-direction: column;
      margin-top: 10px;
    }

    label>span {
      margin-bottom: 10px;
    }

    textarea {
      /* 设计一个 */
      border: 2px solid var(--subColor);
      border-radius: 5px;
      padding: 5px 10px;
      width: 100%;
      height: 60px;
      font-size: 12px;
    }

    input {
      width: 100px;
      height: 40px;
      line-height: 28px;
      padding: 0 5px 0 1rem;
      border: 2px solid transparent;
      border-radius: 8px;
      outline: none;
      border-color: var(--subColor);
      color: #0d0c22;
      transition: 0.3s ease;
      font-size: 12px;
    }

    .input::placeholder {
      color: #9e9ea7;
    }

    .input:focus,
    input:hover {
      outline: none;
      border-color: #9b4fff;
      background-color: #fff;
      box-shadow: 0 0 0 4px rgb(234 76 137 / 10%);
    }

    .formtool {
      position: absolute;
      bottom: 20px;
      right: 30px;
      display: flex;
      gap: 20px;
    }

    .upgrade-btn {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      margin: 50px auto 0;
      width: 125px;
      height: 40px;
      background: #fe638f;
      box-shadow: 0 0.5px 0.5px #EFEFEF, 0 1px 0.5px rgba(239, 239, 239, 0.5);
      border-radius: 7px;
      border: 0;
      outline: none;
      color: #ffffff;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.15, 0.83, 0.66, 1);
      cursor: pointer;
    }

    div.formtool :where(.upgrade-btn:active, .upgrade-btn:hover) {
      color: #fff;
      background-color: rgb(255, 0, 72)
    }

    input:-webkit-autofill::selection {
      -webkit-text-fill-color: #fff !important;
    }

    body::-webkit-scrollbar-track {
      -webkit-box-shadow: inset 0 0 6px rgb(245, 245, 245);
      background-color: #eee;
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 8px;
      background-color: rgb(245, 245, 245);
    }

    ::-webkit-scrollbar-thumb {
      background-color: #d4d4d4 !important;
      border-radius: 20px;
      border: 1px solid rgb(245, 245, 245);
      transition: 1s all;
    }

    .radioType>div {
      display: flex;
      place-content: center;
      gap: 10px;
    }

    .radioType input {
      display: none;
    }

    .radioType>div>div {
      flex: 1;
      height: 100px;
      line-height: 100px;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      background-color: #ddd;
      user-select: none;
    }

    .radioType>div>div.supjav.active {
      background-color: red;
      color: #fff;
    }

    .radioType>div>div.missav.active {
      background-color: #000;
      color: #fff;
    }

    .radioType>div>div.missAv.active span:nth-child(2) {
      color: #fe638f;
    }

    span.av {
      color: #fe638f;
    }

    .layui-layer-content {
      /* color: #000; */
    }

    .layui-timeline-content {
      color: #000;
      background: #00000020;
      border-radius: 12px;
      padding: 10px 10px 10px 20px
    }

    .layui-timeline-content p {
      width: 620px;
      word-wrap: break-word
    }

    .layui-timeline-content p.name {
      font-size: 20px;
      font-weight: 600;
    }

    .layui-timeline-item:before {
      display: none !important;
    }

    .copy,
    .delete {
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .copy:hover,
    .delete:hover {
      background: #fe638f;
      color: #fff;
    }

    .layui-timeline-title {
      display: flex;
      place-items: center;
      place-content: space-between;
    }

    .layui-timeline-title h3 {
      user-select: none;
      background: #fe638f;
      color: #fff;
      border-radius: 5px;
      padding: 1px 25px;
      line-height: 25px;
    }
  </style>
</head>

<body>
  <h1>欢迎来到视频爬取网站 <span class="av">AV.video</span></h1>
  <form id="myForm" method="post" action="/search">
    <label class="radioType" for="urlType">
      <span>视频类型</span>
      <input type="radio" name="urlType" id="missav">
      <input type="radio" name="urlType" id="supjav">
      <div>
        <div class="typeItem supjav active">
          <div>SupJav</div>
        </div>
        <div class="typeItem missav">
          <span>MISS</span>
          <span>AV</span>
        </div>
      </div>
    </label>
    <label for="url" class="textarea">
      <span>视频接口地址</span>
      <textarea type="text"
        name="url">https://ss331.techwodo.com/stream/8/DF/YanJ4R5j41wLnqvgXXIZHpAskdLAUNF75M0/hls1080/YanJ4R5j41wLnqvgXXIZHpAskdLAUNF75M01080.m3u8</textarea>
    </label>
    <label for="headers" style="display: none;">
      <span>线程选择</span>
      <textarea type="text" name="headers">
{
  "Referer": "https://emturbovid.com/",
  "Referrer-Policy": "strict-origin-when-cross-origin"
}
</textarea>
    </label>
    <label for="name">
      <span>名字<span style="font-size: 13px;">(番号后面如果没有空格的话,请在番号后面加一个空格)</span></span>
      <input style="width: 100%;" type="text" name="name"
        value="[无码破解]IPZZ-132 chu！chu！chu！ 「桃ちゃん」と刺激的な初お泊りデートで超浓密エッチ朝・昼・夜性が止まらない！！ 桃乃木かな" />
    </label>
    <label for="cover">
      <span style="margin: 0;">内容封面
        <span class="tips" lay-on="test-tips-color" style="cursor: pointer;">
          <i class="layui-icon layui-icon-question"></i>
        </span>
      </span>
      <input style="width: 100%;" type="text" name="cover"
        value='url("https://ver1.sptvp.com/poster/2/A2/HWQmVy1jJg0NsOiG8kM0-55.png")' />
    </label>
    <label for="thread">
      <span>线程选择</span>
      <input style="width: 100%;" type="number" name="thread" value="20" max="20" min="1" />
    </label>
    <div class="formtool">
      <button class="upgrade-btn" type="button" lay-on="lookHistory">查看历史</button>
      <a href="/" class="upgrade-btn">返回主页</a>
      <button class="upgrade-btn" type="submit">提交</button>
    </div>
  </form>
  <div id="designations" data-designations="{{designations}}"></div>
</body>
<script src="jquery.min.js"></script>
<script src="layui/layui.js"></script>
<script type="text/html" id="modulesitem">
  <div class="layui-timeline-item">
    <div class="layui-timeline-content layui-text">
      <div class="layui-timeline-title">
        <h3>过去</h3>
        <div>
          <i class="layui-icon layui-icon-transfer copy"></i>
          <i class="layui-icon layui-icon-delete delete"></i>
        </div>
      </div> 
      <p class="name"></p>
      <p class="cover"></p>
      <p class="url"></p>
    </div>
  </div>
</script>

<script>
  //获取库内所有番号
  const designations = $('#designations').data('designations').split(',')
  $('#designations').remove()
  let data = localStorage.getItem('Download_History')
  if (data) {
    data = JSON.parse(data)
    $('input[name="name"]').val(data[0].name)
    $('input[name="cover"]').val(data[0].cover)
    $('input[name="thread"]').val(data[0].thread)
    $('textarea[name="url"]').text(data[0].url)
  }
  //避免重复下载，提交两次请求申请
  let isDownloading = false
  layui.use(function () {

    var layer = layui.layer;
    var util = layui.util;
    // 获取表单元素
    var form = document.getElementById('myForm');

    // 监听表单提交事件
    form.addEventListener('submit', function (event) {
      if (isDownloading === true) return
      isDownloading = true
      // 阻止默认的表单提交行为
      event.preventDefault();
      // 获取表单数据
      var formData = new FormData(form);
      let data = {}
      for (const item of formData.entries()) {
        data = { ...data, [item[0]]: item[1] }
      }
      //判断番号是否存在
      const isExist = designations.includes(data.name.match(/[a-zA-Z]*-[0-9]{3}/)[0])
      if (isExist) {
        isDownloading = false
        return layer.msg('番号已存在')
      }
      //存储历史记录
      setLocalStore(data, util)
      let loadIndex
      // 发送ajax请求
      $.ajax({
        url: '/search',
        method: 'post',
        data: data,
        beforeSend: function () {
          loadIndex = layer.load(0, {
            shade: .6,
            fixed: true,
            content: '正在下载中...',
          });
        },
        success: function (result) {
          // 显示等待组件
          layer.msg('下载完成')
          layer.close(loadIndex);
          isDownloading = false
        },
        error: function (err) {
          layer.close(loadIndex);
        }
      })
    })
    const typeItem = document.querySelectorAll('.typeItem')

    typeItem.forEach((res) => {
      res.addEventListener('click', function () {
        typeItem.forEach((res) => {
          res.classList.remove('active')
        })
        this.classList.add('active')
        const type = res.className.split(' ')[1]
        const input = document.querySelector(`input#${type}`)
        input.checked = true
        const headerItem = document.querySelector('textarea[name="headers"]')
        if (type === 'supjav') {
          headerItem.innerHTML = `{
          "Referer": "https://emturbovid.com/",
          "Referrer-Policy": "strict-origin-when-cross-origin"
        }`
        } else if (type === 'missav') {
          headerItem.innerHTML = `{
          "Origin": "https://missav.com",
          "Referer": "https://missav.com/cn/pppd-985-uncensored-leak"
        }`
        }
      })
    })

    // 事件
    util.on('lay-on', {
      'test-tips-color': function () {
        layer.tips('(在页面F12中运行) $("#myElement").find(".jw-preview.jw-reset").css("background-image")', this, {
          tips: [1, '#FE638F'],
          tipsMore: true
        });
        layer.tips('获得路径url("https://ver1.sptvp.com/poster....png")', this, {
          tips: [3, '#FE638F'],
          tipsMore: true
        })
      },
    })
    // 查看历史
    // 事件
    util.on('lay-on', {
      'lookHistory': function () {
        let html = `还没存历史记录...`
        if (data) {
          let content = ''
          data.forEach(res => {
            content += $("script#modulesitem").html()
          })
          html = `<div class="layui-timeline">${content}</div>`
        }

        layer.open({
          type: 1,
          area: ['700px', '90%'], // 宽高
          title: '历史记录',
          anim: 1,
          content: `<div style="padding: 11px;">${html}</div>`,
          success: function (layero, index, that) {
            let i = 0
            $('.layui-timeline').find('.layui-timeline-item').each((i, item) => {
              $(item).find('.name').text(data[i].name)
              $(item).find('.cover').text(data[i].cover)
              $(item).find('.url').text(data[i].url)
              $(item).find('h3').text(data[i].downloadTime || '过去（未知）')
              $(item).find('.copy').on('click', function () {
                copyToClipboard(data[i].cover)
                setTimeout(() => {
                  copyToClipboard(data[i].name)
                }, 300)
                setTimeout(() => {
                  copyToClipboard(data[i].url)
                  layer.msg('复制成功')
                }, 600)
              })
              $(item).find('.delete').on('click', function () {
                const item = data.splice(i, 1)
                localStorage.setItem('Download_History', JSON.stringify(item))
                //删除元素
                $(this).parent().parent().parent().parent().remove()
              })
            })
          }
        });
      },
    })
  });

  function setLocalStore(data, util) {
    const newdate = new Date()
    var result = util.toDateString(newdate.getTime(), 'yyyy年MM月dd日 hh:mm:ss'); // 2023-01-01
    data.downloadTime = result
    const oldStorage = localStorage.getItem('Download_History')
    if (!oldStorage) {
      localStorage.setItem('Download_History', JSON.stringify([data]))
    } else {
      localStorage.setItem('Download_History', JSON.stringify([data, ...JSON.parse(oldStorage)]))
    }
  }
  function copyToClipboard(text) {
    var textarea = document.createElement("textarea");
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand("copy");
    document.body.removeChild(textarea);
  }
  // 防抖
  function debounce(fn, timer) {
    var debItem = null
    return function () {
      var arg = arguments[0]   //获取事件
      if (debItem) {
        clearTimeout(debItem)
      }
      debItem = setTimeout(() => {
        fn(arg)              //事件传入函数
      }, timer)
    }
  }
</script>

</html>

</html>
